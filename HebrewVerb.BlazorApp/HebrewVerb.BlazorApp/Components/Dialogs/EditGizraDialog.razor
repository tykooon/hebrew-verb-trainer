@using HebrewVerb.Application.Feature.Gizras.Commands
@using HebrewVerb.Application.Feature.Gizras.Queries
@using HebrewVerb.Application.Models
@using HebrewVerb.Application.Models.Validators
@inject IMediator _mediator
@inject ISnackbar _snackbar


<MudDialog Style="min-width:50vw">
    <DialogContent>
        <MudForm @ref=_form Model="GizraModel" Validation="@(Validator.ValidateValue)">
            <MudTextField T="string" @bind-Value=GizraModel.Name For="@(() => GizraModel.Name)" Label="Название"></MudTextField>
            <MudTextField T="string" @bind-Value=GizraModel.Description Label="Краткое описание"></MudTextField>
            <BinyanFilter Options="GizraBinyans" OptionsChanged="OnBinyansChanged"></BinyanFilter>
        </MudForm>
    </DialogContent>
    <DialogActions>
            <MudButton Class="me-6" Variant="Variant.Filled" OnClick="Cancel">ОТМЕНА</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Submit">СОХРАНИТЬ</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }


    [Parameter]
    public int GizraId { get; set; }

    [Parameter]
    public bool IsNew { get; set; }

    [Parameter]
    public EventCallback OnSuccess { get;set; }

    private MudForm _form;
    private GizraDtoValidator Validator; 

    private GizraDto GizraModel { get; set; } = new();

    private IEnumerable<Binyan> GizraBinyans { get; set; } = [];

    private void OnBinyansChanged(IEnumerable<Binyan> binyans)
    {
        GizraBinyans = binyans;
        GizraModel.Binyans = binyans.GetBinyanNames();
    }

    void Cancel() => MudDialog.Cancel();

    async Task Submit()
    {
        await _form.Validate();

        if (!_form.IsValid)
        {
            return;
        }

        var res = new Ardalis.Result.Result();
        if (IsNew)
        {
            var addCommand = new AddNewGizraCommand(GizraModel.Name, GizraModel.Description, GizraModel.Binyans);
            res = await _mediator.Send(addCommand);
        }
        else
        {
            var updateCommand = new UpdateGizraCommand(GizraModel);
            res = await _mediator.Send(updateCommand);
        }

        if (res?.IsSuccess == true)
        {
            _snackbar.Add(IsNew ? "Gizra Successfully Created" : "Gizra Successfully Updated", Severity.Success);
            MudDialog.Cancel();
            await OnSuccess.InvokeAsync();
        }
        else
        {
            var errorMsg = string.Join(", ", res?.Errors ?? []);
            _snackbar.Add($"Errors: {errorMsg}", Severity.Error);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        if (!IsNew)
        {
            var query = new GetGizraByIdQuery(GizraId);
            var res = await _mediator.Send(query);

            if (res == null)
            {
                MudDialog.Cancel();
            }
            else
            {
                GizraModel = res;
                GizraBinyans = GizraModel.Binyans.GetBinyans();
            }
        }
        else
        {
            GizraModel = new();
        }

        Validator = new(_mediator);
    }
}
