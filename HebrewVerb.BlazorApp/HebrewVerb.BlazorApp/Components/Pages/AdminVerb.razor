@page "/verbadmin"

@inject ISnackbar Snackbar
@using HebrewVerb.Application.Feature.Gizras.Commands
@using HebrewVerb.Application.Feature.Verbs.Commands
@using HebrewVerb.Application.Feature.Verbs.Queries
@using HebrewVerb.BlazorApp.Services
@using HebrewVerb.BlazorApp.ViewModels
@using HebrewVerb.Application.Models
@using Microsoft.Extensions.Caching.Distributed
@inject IMediator _mediator
@inject IDistributedCache _cache
@rendermode InteractiveAuto

<PageTitle>Verb Data Editing</PageTitle>

<FilterBar @ref="_filterBar" @bind-CurrentFilter="FilterData" 
    ZmanDisabled="true">
</FilterBar>

<MudContainer MaxWidth="MaxWidth.Medium" Class="justify-content-center mt-2">
    <MudGrid Justify="Justify.Center">
        <MudItem>
            <MudButton Variant="Variant.Filled" FullWidth Class="mx-3" Color="Color.Secondary"
                StartIcon="@Icons.Material.Filled.Add" OnClick="@(() => ToggleOpen(AdminPagePopover.AddVerb))">
                <TextHider Intro="Add">Verb</TextHider>
             </MudButton>
        </MudItem>
        <AddVerbPopover @bind-IsOpen=@_addVerbIsOpen></AddVerbPopover>

        <MudItem>
             <MudButton Variant="Variant.Filled" FullWidth Class="mx-3" Color="Color.Secondary"
                 StartIcon="@Icons.Material.Filled.Add" OnClick="@(()=> ToggleOpen(AdminPagePopover.AddGizra))">
                 <TextHider Intro="Add">Gizra</TextHider>
             </MudButton>
        </MudItem>
        <AddGizraPopover @bind-IsOpen=@_addGizraIsOpen NewGizraCreated=@(async () => await FilterBarRefresh(RefreshOption.GizraFilter))></AddGizraPopover>

        <MudItem>
             <MudButton Variant="Variant.Filled" FullWidth Class="mx-3" Color="Color.Secondary"
                 StartIcon="@Icons.Material.Filled.Add" OnClick="@(()=> ToggleOpen(AdminPagePopover.AddModel))">
                 <TextHider Intro="Add">Verb Model</TextHider>
             </MudButton>
        </MudItem>
         <AddVerbModelPopover @bind-IsOpen=@_addModelIsOpen NewVerbModelCreated=@(async () => await FilterBarRefresh(RefreshOption.VerbModelFilter))></AddVerbModelPopover>

        <MudItem>
             <MudButton Variant="Variant.Filled" FullWidth Class="mx-3" Color="Color.Primary"
                 StartIcon="@Icons.Material.Filled.Download">
                 <TextHider Outtro="filtered">Load</TextHider>
             </MudButton>
        </MudItem>
    </MudGrid>

    <VerbTableFull></VerbTableFull>

</MudContainer>

 @code {
    private FilterViewModel FilterData = new();

    private FilterBar _filterBar = new();

    private async Task FilterBarRefresh(RefreshOption option = RefreshOption.None)
    {
        switch (option)
        {
            case RefreshOption.GizraFilter:
                _cache.Remove(Constants.GizraList);
                break;
            case RefreshOption.VerbModelFilter:
                _cache.Remove(Constants.VerbModelList);
                break;
            case RefreshOption.None:
                break;
        }        
        await _filterBar.RefreshFilter();
    }
}
